---
import fs from 'node:fs';
import { ClientRouter } from 'astro:transitions';
import '@/styles/base.css';
import type { Meta, Voice, Locale } from '@/lib';
import {
  LOCALE_LABELS,
  generateStaticPaths,
  getAvailableLocales,
  loadMeta,
  loadVoices,
  buildAssetPath,
  generatePageMeta,
  getOGLocale,
  generateJsonLd,
  resolveTheme,
  generateThemeCSS,
} from '@/lib';
import Hero from '@/components/Hero.astro';
import HeroMedia from '@/components/HeroMedia.astro';
import Gallery from '@/components/Gallery.astro';
import Voices from '@/components/Voices.astro';
import CTA from '@/components/CTA.astro';
import Footer from '@/components/Footer.astro';

const metas = import.meta.glob<{ default: Meta }>('../../../data/*/*/meta.json', { eager: true });
const voicesAll = import.meta.glob<{ default: Voice[] }>('../../../data/*/*/voices.json', {
  eager: true,
});

export function getStaticPaths() {
  const metas = import.meta.glob('../../../data/*/*/meta.json', { eager: true });
  return generateStaticPaths(metas);
}

const { app, locale: localeParam } = Astro.params;
const locale = localeParam as Locale;
const base = import.meta.env.BASE_URL;
const site = Astro.site?.origin ?? '';

const meta = loadMeta(metas, app, locale);
const voices = loadVoices(voicesAll, app, locale);

const assetBase = buildAssetPath(base, app);
const heroWebp = buildAssetPath(base, app, 'hero.webp');
const heroMp4 = buildAssetPath(base, app, 'hero.mp4');
const iconPng = buildAssetPath(base, app, 'icon.png');
const hasVideo = fs.existsSync(`./public/content/${app}/hero.mp4`);

const availableLocales = getAvailableLocales(app, metas);
const theme = resolveTheme(meta.theme);
const themeCSS = generateThemeCSS(theme);

const pageUrl = Astro.url.href;
const pageMeta = generatePageMeta(meta, site, assetBase, pageUrl);
const jsonLd = generateJsonLd(meta, pageUrl, pageMeta.ogImage, pageMeta.description);
const ogLocale = getOGLocale(locale);
---

<!doctype html>
<html lang={locale}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{pageMeta.title}</title>
    <meta name="description" content={pageMeta.description} />
    <link rel="icon" href={iconPng} />
    <link rel="canonical" href={pageUrl} />
    <link rel="preload" href={heroWebp} as="image" />
    {
      availableLocales.map((l) => (
        <link rel="alternate" hreflang={l} href={`${site}${base}${app}/${l}/`} />
      ))
    }
    <link
      rel="alternate"
      hreflang="x-default"
      href={`${site}${base}${app}/${availableLocales[0]}/`}
    />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={meta.name} />
    <meta property="og:locale" content={ogLocale} />
    <meta property="og:url" content={pageUrl} />
    <meta property="og:title" content={pageMeta.title} />
    <meta property="og:description" content={pageMeta.description} />
    <meta property="og:image" content={pageMeta.ogImage} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageMeta.title} />
    <meta name="twitter:description" content={pageMeta.description} />
    <meta name="twitter:image" content={pageMeta.ogImage} />
    <script is:inline type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
    <Fragment set:html={`<style>${themeCSS}</style>`} />
    <ClientRouter />
  </head>
  <body>
    <a href="#main" class="skip-link">Skip to content</a>
    <main id="main" class="section">
      <Hero
        iconSrc={iconPng}
        name={meta.name}
        tagline={meta.catch}
        locales={availableLocales}
        currentLocale={locale}
        localeLabels={LOCALE_LABELS}
        basePath={base}
        app={app}
      />

      <HeroMedia hasVideo={hasVideo} videoSrc={heroMp4} imageSrc={heroWebp} alt={meta.name} />

      {
        meta.description && (
          <section class="fade-in">
            <p class="desc">{meta.description}</p>
          </section>
        )
      }

      {meta.links?.play && <CTA href={meta.links.play} locale={locale} />}

      {meta.gallery && <Gallery images={meta.gallery} basePath={base} />}

      <Voices voices={voices} />

      <Footer author={meta.author} links={meta.links} />
    </main>

    <script>
      import { setupFadeIn } from '@/scripts/fade-in';
      setupFadeIn();
    </script>
  </body>
</html>
