---
import Base from '@/layouts/Base.astro';
import type { Meta } from '@/lib';
import { parseGlobPath, buildAssetPath } from '@/lib';

const rawBase = import.meta.env.BASE_URL;
const base = rawBase.endsWith('/') ? rawBase : `${rawBase}/`;
const metas = import.meta.glob<{ default: Meta }>('../data/*/*/meta.json', { eager: true });

// Group by app
const apps = new Map<string, { locales: string[]; meta: Meta; icon: string }>();

for (const [path, mod] of Object.entries(metas)) {
  const parsed = parseGlobPath(path);
  if (!parsed) continue;

  const { app, locale } = parsed;
  if (!apps.has(app)) {
    apps.set(app, {
      locales: [],
      meta: mod.default,
      icon: buildAssetPath(base, app, 'icon.webp'),
    });
  }
  apps.get(app)!.locales.push(locale);
}

// Sort locales consistently
for (const data of apps.values()) {
  data.locales.sort((a, b) => {
    const order = ['ja', 'en', 'zh-cn'];
    return order.indexOf(a) - order.indexOf(b);
  });
}
---

<Base title="Apps" description="App landing pages" noindex>
  <main class="index-main">
    <h1>Apps</h1>

    <ul class="app-grid">
      {
        [...apps.entries()].map(([app, { locales, meta, icon }]) => (
          <li class="app-item">
            <img src={icon} alt="" class="app-icon" />
            <span class="app-name">{meta.name}</span>
            <nav class="app-links">
              {locales.map((l) => (
                <a href={`${base}${app}/${l}/`}>{l.toUpperCase()}</a>
              ))}
            </nav>
          </li>
        ))
      }
    </ul>
  </main>

  <style>
    .index-main {
      max-width: 600px;
      margin: 0 auto;
      padding: 48px 24px;
    }

    .index-main h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 32px;
      color: var(--muted);
    }

    .app-grid {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .app-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 8px;
      transition: background 0.15s;
    }

    .app-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .app-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      flex-shrink: 0;
    }

    .app-name {
      flex: 1;
      font-weight: 500;
      font-size: 1rem;
    }

    .app-links {
      display: flex;
      gap: 6px;
    }

    .app-links a {
      padding: 4px 8px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--accent);
      border: 1px solid var(--accent);
      border-radius: 4px;
      text-decoration: none;
      transition: all 0.15s;
    }

    .app-links a:hover {
      background: var(--accent);
      color: var(--bg);
    }
  </style>
</Base>
